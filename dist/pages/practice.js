"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_chatMessage=require("./../components/chatMessage.js"),_chatMessage2=_interopRequireDefault(_chatMessage),_loading=require("./../components/loading.js"),_loading2=_interopRequireDefault(_loading),_Message=require("./../model/Message.js"),_config=require("./../config.js"),_config2=_interopRequireDefault(_config),_api=require("./../api/index.js"),_util=require("./../util/index.js"),Practice=function(e){function t(){var e,n,s,o;_classCallCheck(this,t);for(var a=arguments.length,i=Array(a),r=0;r<a;r++)i[r]=arguments[r];return n=s=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),s.config={navigationBarTitleText:"个性化学习中心"},s.data={filterConditionVisible:!1,filterType:0,isTeacher:!1,haveActiveGroupTask:!0,userInfo:null,arrangeList:[],arrangeIndex:0,inputMode:"TEXT",userTextInput:"",userTextContent:"",moreActionShown:!1,messageId:"",userInfoForMsg:{},messages:[],currentMsgsPageIndex:1,haveMoreChatMsgs:!0,isFocus:!1,isLoadingMsg:!1,unsendMessages:[],textareaHeight:40,isScrollToNewEnable:!0},s.$repeat={messages:{com:"chat-message",props:"msgData.sync"}},s.$props={"chat-message":{"xmlns:v-bind":{value:"",for:"messages",item:"item",index:"index",key:"index"},"v-bind:id.once":{value:"'message_' + item.MessageID",for:"messages",item:"item",index:"index",key:"index"},"v-bind:msgData.sync":{value:"item",type:"item",for:"messages",item:"item",index:"index",key:"index"},"v-bind:isSelf.once":{value:"item.isSelf",for:"messages",item:"item",index:"index",key:"index"},"v-bind:isShowMore.once":{value:"item.isShowMore",for:"messages",item:"item",index:"index",key:"index"}},loading:{}},s.$events={},s.components={"chat-message":_chatMessage2.default,loading:_loading2.default},s.computed={chatHistoryHeight:function(){return this.moreActionShown?"calc(100vh - 410rpx - "+this.textareaHeight+"rpx)":"calc(100vh - 210rpx - "+this.textareaHeight+"rpx)"},btnToolHeight:function(){return this.textareaHeight+48+"rpx"}},s.methods={arrangeStepChange:function(e){this.arrangeIndex=+e.detail.value},onInputText:function(e){console.log("input",e.detail.value),this.userTextInput=e.detail.value},toggleFilterCondition:function(){this.filterConditionVisible=!this.filterConditionVisible,this.$apply()},filtChatHistory:function(e){this.filterType="1"===e?1:"2"===e?2:0,this.filterConditionVisible=!1,this.initChatHistory()},setInputMode:function(){"TEXT"===this.inputMode?this.inputMode="AUDIO":this.inputMode="TEXT"},sendTextMsg:function(){var e=this;this.sendCommonMsg("1",this.userTextInput).then(function(t){e.userTextInput="",e.userTextContent=" ",e.textareaHeight=40,setTimeout(function(){e.userTextContent=""},0),e.$apply()})},showMoreActions:function(){this.moreActionShown=!this.moreActionShown},uploadPic:function(){var e=this;_wepy2.default.chooseImage({count:4,success:function(t){t.tempFilePaths.forEach(function(t){(0,_api.uploadFile)(t,{FileType:2,userFID:e.$parent.globalData.userInfo.FlnkID}).then(function(t){e.sendCommonMsg("2",t.FileLink,t.FileId)},function(e){_wepy2.default.showToast({title:"发送失败",icon:"none"})})})}})},takePhoto:function(){var e=this;_wepy2.default.chooseVideo({sourceType:["album","camera"],maxDuration:60,camera:"back",success:function(t){if(console.log("success:",t),t.duration>60)return void _wepy2.default.showToast({title:"视频不能超过1分钟",icon:"none"});var n=t.tempFilePath;_wepy2.default.showLoading({title:"正在上传"}),(0,_api.uploadFile)(n,{FileType:3,userFID:e.$parent.globalData.userInfo.FlnkID}).then(function(t){_wepy2.default.hideLoading(),e.sendCommonMsg("3",t.FileLink,t.FileId)},function(e){_wepy2.default.hideLoading(),_wepy2.default.showToast({title:"发送失败",icon:"none"})})},fail:function(e){console.log("fail:",e),console.error(e)}})},startRecordAudio:function(){var e=this,t=_wepy2.default.getRecorderManager();t.onStop(function(t){var n=t.tempFilePath;(0,_api.uploadFile)(n,{FileType:4,userFID:e.$parent.globalData.userInfo.FlnkID}).then(function(t){e.sendCommonMsg("4",t.FileLink,t.FileId)},function(e){_wepy2.default.showToast({title:"发送失败",icon:"none"})})}),t.onError(function(e){_wepy2.default.showToast({title:"发送失败",icon:"none"})});var n={duration:6e5,sampleRate:44100,numberOfChannels:1,encodeBitRate:192e3,format:"mp3"};t.start(n)},stopRecordAudio:function(){_wepy2.default.getRecorderManager().stop()},hideChatMsgMore:function(){this.messages.forEach(function(e){e.isShowMore=!1}),this.$apply()},hideActionBtns:function(){this.moreActionShown=!1,this.filterConditionVisible=!1,this.chatHistoryHeight="calc(100vh - 250rpx)",this.$apply()},onScrollUpper:function(e){var t=this;this.haveMoreChatMsgs&&(this.currentMsgsPageIndex++,this.loadChatMsgByPage(this.currentMsgsPageIndex).then(function(e){var n=t.messages[0].MessageID;t.messages=e.concat(t.messages),t.messageId="message_"+n,t.$apply()}))},onChatScroll:function(e){e.detail.scrollHeight-e.detail.scrollTop>800?this.isScrollToNewEnable=!1:this.isScrollToNewEnable=!0},onDeleteMsg:function(e){console.log(e)},focusTextArea:function(){this.isFocus=!0,this.$apply()},cancelFocus:function(e){this.isFocus=!1,this.$apply()},inputLineChange:function(e){e.detail.lineCount<=5&&(this.textareaHeight=e.detail.heightRpx,this.$apply())}},s.events={"hide-other-actions":function(e){console.log(e),this.messages.forEach(function(t){t.isShowMore=t.MessageID===e.MessageID}),this.$apply()},"delete-msg":function(e){var t=this;e.FromUser===this.$parent.globalData.userInfo.FlnkID?(0,_api.deleteChatMsg)(e.MessageID,e.FromUser).then(function(n){var s=t.messages.findIndex(function(t){return t.MessageID===e.MessageID});t.messages.splice(s,1),t.$apply()}):_wepy2.default.showToast({title:"不可删除",icon:"none"})},"preview-image":function(e){this.$parent.setGlobalData("isPreviewImg",!0)}},o=n,_possibleConstructorReturn(s,o)}return _inherits(t,e),_createClass(t,[{key:"sendCommonMsg",value:function(e,t,n){var s={},o=this;this.arrangeIndex>0&&(s=this.arrangeList[this.arrangeIndex]);var a=new _Message.Message(this.userInfoForMsg,{msgtype:e||"1",msgcontent:t,msgkey:n||"",stepkey:s.FlnkID||"",stepcode:s.SortCode||"",stepname:s.ArrangeName||""});return new Promise(function(s,i){_wepy2.default.sendSocketMessage({data:JSON.stringify(a),success:function(e){o.arrangeIndex=0,o.$apply(),s(e)},fail:function(s){o.unsendMessages.push({msgtype:e||"1",msgcontent:t,msgkey:n||""}),o.startSocket(!0),i(s)}})})}},{key:"scrollToCurrentMsg",value:function(){this.messageId="message_"+this.messages[this.messages.length-1].MessageID,this.$apply()}},{key:"init",value:function(){var e=_wepy2.default.getStorageSync("activeTaskInfo");this.haveActiveGroupTask=!!e,this.haveActiveGroupTask&&(this.initSteps(e),this.initChatHistory(),this.userInfoForMsg={userId:this.$parent.globalData.userInfo.FlnkID,userName:this.$parent.globalData.userInfo.XM,RoleNum:this.$parent.globalData.userInfo.RoleNum,AvatarUrl:this.$parent.globalData.wxUserInfo.avatarUrl,groupId:e.GroupFID},this.startSocket())}},{key:"initSteps",value:function(e){var t=this;(0,_api.getCourseArrangeList)(e.CourseFID,e.GroupFID).then(function(e){var n=e,s=[{showArrangeName:"不提交步骤",FlnkID:"",pFlnkID:"",pSortCode:""}];n.forEach(function(e){e.modelList[0]&&1===e.modelList[0].ArrangeType?e.modelList.forEach(function(t){1===t.ArrangeType&&t.IsCheck&&s.push({showArrangeName:"步骤"+e.SortCode+"."+t.SortCode+" : "+t.ArrangeContent,ArrangeName:t.ArrangeContent,FlnkID:t.FlnkID,pFlnkID:e.FlnkID,pSortCode:e.SortCode,SortCode:e.SortCode+"."+t.SortCode})}):s.push({showArrangeName:"步骤"+e.SortCode+":"+e.ArrangeName,ArrangeName:e.ArrangeName,FlnkID:e.modelList[0].FlnkID,pFlnkID:e.FlnkID,pSortCode:e.SortCode,SortCode:e.SortCode})}),t.arrangeList=s,t.$apply()})}},{key:"initChatHistory",value:function(){var e=this;this.currentMsgsPageIndex=1,this.haveMoreChatMsgs=!0,this.loadChatMsgByPage(1).then(function(t){e.messages=[].concat(t),e.$apply(),e.scrollToCurrentMsg()})}},{key:"loadChatMsgByPage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.isLoadingMsg=!0;var n=_wepy2.default.getStorageSync("activeTaskInfo");return new Promise(function(s,o){var a="",i=null;1===e.filterType?a=e.$parent.globalData.userInfo.FlnkID:2===e.filterType&&(i=2),(0,_api.getChatMsgByPage)(n.GroupFID,a,i,t).then(function(t){t.PageCount<=e.currentMsgsPageIndex?e.haveMoreChatMsgs=!1:e.haveMoreChatMsgs=!0;var n=t.DataSource,o=[];n.forEach(function(t){var n=JSON.parse(t.MessageBody);n.isSelf=n.FromUser===e.$parent.globalData.userInfo.FlnkID,n.showSendTime=(0,_util.getMessageSendTime)(t.SendTime+"+0800"),o.unshift(n)}),e.isLoadingMsg=!1,s(o)},function(t){e.isLoadingMsg=!1,e.haveMoreChatMsgs=!0,o(t)})})}},{key:"startSocket",value:function(e){var t=this;if(e&&this.$parent.setGlobalData("isInitSocket",!1),!this.$parent.globalData.isInitSocket){this.$parent.setGlobalData("isInitSocket",!0);var n=this;_wepy2.default.connectSocket({url:_config2.default.socketServerUrl,success:function(e){console.log("连接成功")},fail:function(e){console.error("连接失败")}}),_wepy2.default.onSocketOpen(function(e){var s=new _Message.Message(t.userInfoForMsg,{},0);_wepy2.default.sendSocketMessage({data:JSON.stringify(s),success:function(e){console.log("进入房间成功！"),n.unsendMessages&&n.unsendMessages.length>0&&(n.unsendMessages.forEach(function(e){n.sendCommonMsg(e.msgtype,e.msgcontent,e.msgkey).then(function(e){n.userTextInput="",n.userTextContent="",n.textareaHeight=40,n.$apply()})}),n.unsendMessages=[],n.$apply())},fail:function(){console.log("进入房间失败！")}}),_wepy2.default.onSocketMessage(function(e){var n=JSON.parse(e.data);n.isSelf=n.FromUser===t.$parent.globalData.userInfo.FlnkID,n.showSendTime=(0,_util.getMessageSendTime)(n.MessageTime),t.messages.push(n),t.$apply(),(n.isSelf||t.isScrollToNewEnable)&&t.scrollToCurrentMsg();var s=getCurrentPages();"pages/practice"!==s[s.length-1].route&&_wepy2.default.showTabBarRedDot({index:1})})})}}},{key:"onShow",value:function(){var e=this;if(_wepy2.default.hideTabBarRedDot({index:1}),this.$parent.getUserInfo().then(function(t){e.userInfo=t}),this.isTeacher=this.$parent.globalData.userInfo.RoleNum+""=="2",this.$parent.globalData.isPreviewImg)return void this.$parent.setGlobalData("isPreviewImg",!1);this.init()}},{key:"onUnload",value:function(){this.$parent.setGlobalData("isInitSocket",!1),console.log("页面卸载"),_wepy2.default.closeSocket({success:function(){console.log("断开socket成功")}})}}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(Practice,"pages/practice"));