"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_chatMessage=require("./../../components/chatMessage.js"),_chatMessage2=_interopRequireDefault(_chatMessage),_panel=require("./../../components/panel.js"),_panel2=_interopRequireDefault(_panel),_remarkTpl=require("./../../components/remark-tpl.js"),_remarkTpl2=_interopRequireDefault(_remarkTpl),_remarkRecord=require("./../../components/remark-record.js"),_remarkRecord2=_interopRequireDefault(_remarkRecord),_api=require("./../../api/index.js"),ReviewPractice=function(e){function t(){var e,r,a,s;_classCallCheck(this,t);for(var n=arguments.length,i=Array(n),o=0;o<n;o++)i[o]=arguments[o];return r=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),a.config={navigationBarTitleText:"个性化学习中心"},a.data={isTeacher:!1,userInfo:null,chatHistoryHeight:"calc(100vh - 88rpx)",moreActionShown:!1,messageId:"",userInfoForMsg:{},messages:[],currentMsgsPageIndex:1,haveMoreChatMsgs:!0,CourseFID:"",GroupFID:"",isTeacherRemarked:!1,remarkList:null,isStuInGroup:!1},a.$repeat={messages:{com:"chat-message",props:"msgData.sync"},remarkList:{com:"remark-record",props:"groupMember.sync"}},a.$props={"chat-message":{"xmlns:v-bind":{value:"",for:"messages",item:"item",index:"index",key:"index"},"v-bind:id.once":{value:"'message_' + item.MessageID",for:"messages",item:"item",index:"index",key:"index"},"v-bind:msgData.sync":{value:"item",type:"item",for:"messages",item:"item",index:"index",key:"index"},"v-bind:isSelf.once":{value:"item.isSelf",for:"messages",item:"item",index:"index",key:"index"},"v-bind:isShowMore.once":{value:"item.isShowMore",for:"messages",item:"item",index:"index",key:"index"},editable:{value:"{{false}}",for:"messages",item:"item",index:"index",key:"index"}},"remark-record":{"v-bind:groupMember.sync":{value:"item",type:"item",for:"remarkList",item:"item",index:"index",key:"key"}}},a.$events={},a.components={"chat-message":_chatMessage2.default,panel:_panel2.default,"remark-tpl":_remarkTpl2.default,"remark-record":_remarkRecord2.default},a.computed={},a.methods={onScrollUpper:function(e){var t=this;this.haveMoreChatMsgs&&(this.currentMsgsPageIndex++,this.loadChatMsgByPage(this.currentMsgsPageIndex).then(function(e){var r=t.messages[0].MessageID;t.messages=e.concat(t.messages),t.messageId="message_"+r,t.$apply()}))}},a.events={"hide-other-actions":function(e){},"delete-msg":function(e){}},s=r,_possibleConstructorReturn(a,s)}return _inherits(t,e),_createClass(t,[{key:"scrollToCurrentMsg",value:function(){this.messageId="message_"+this.messages[this.messages.length-1].MessageID,this.$apply()}},{key:"init",value:function(){var e=this;this.initChatHistory(),this.initTeacherRemark(),(0,_api.isStuInCourseGroup)(this.$parent.globalData.userInfo.FlnkID,this.CourseFID,this.GroupFID).then(function(t){e.isStuInGroup=t,e.$apply()},function(){e.isStuInGroup=!1,e.$apply()})}},{key:"initChatHistory",value:function(){var e=this;this.loadChatMsgByPage(1).then(function(t){e.messages=[].concat(t),e.$apply(),e.scrollToCurrentMsg()})}},{key:"loadChatMsgByPage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return new Promise(function(r,a){(0,_api.getChatMsgByPage)(e.GroupFID,"",null,t).then(function(t){t.PageCount<=e.currentMsgsPageIndex?e.haveMoreChatMsgs=!1:e.haveMoreChatMsgs=!0;var a=t.DataSource,s=[];a.forEach(function(t){var r=JSON.parse(t.MessageBody);r.isSelf=r.FromUser===e.$parent.globalData.userInfo.FlnkID,s.unshift(r)}),r(s)},function(t){e.haveMoreChatMsgs=!0,a(t)})})}},{key:"initTeacherRemark",value:function(){var e=this;(0,_api.getTeacherRemarkByGroup)(this.GroupFID).then(function(t){t=t||[],t.forEach(function(e){e.modelList.forEach(function(e){e.ReflectName=e.ReflectCategoryName,e.modelList.forEach(function(e){e.ReflectItemName=e.ReflectContent,e.stuStarValue=e.StarValue||0,e.StarValue=e.TotalStarValue-e.stuStarValue})})}),e.remarkList=t||[],e.$apply()},function(t){e.remarkList=[],e.$apply()})}},{key:"onLoad",value:function(e){this.isTeacher=this.$parent.globalData.userInfo.RoleNum+""=="2",this.CourseFID=e.courseId,this.GroupFID=e.groupId,this.init()}},{key:"onUnload",value:function(){}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(ReviewPractice,"practice/pages/reviewFinishTask"));