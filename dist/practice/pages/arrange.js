"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_stepList=require("./../../components/step-list.js"),_stepList2=_interopRequireDefault(_stepList),_richButton=require("./../../components/rich-button.js"),_richButton2=_interopRequireDefault(_richButton),_dialog=require("./../../components/dialog.js"),_dialog2=_interopRequireDefault(_dialog),_api=require("./../../api/index.js"),_Step=require("./../../model/Step.js"),Arrange=function(e){function t(){var e,i,r,n;_classCallCheck(this,t);for(var a=arguments.length,s=Array(a),o=0;o<a;o++)s[o]=arguments[o];return i=r=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),r.config={navigationBarTitleText:"会安排"},r.data={parentScrollTop:0,isTeacher:!1,userInfo:null,isUserLeader:!1,isChanged:!1,scrollable:!0,addStepDialogVisible:!1,stepName:"",stepDesc:"",addStepTitle:"添加步骤",toEditStep:null,datalist:[],currentGroupInfo:null,queryParam:null,navigateUrlMap:{prevKnow:"/practice/pages/prevKnow",practice:"/pages/practice",practiceOpenType:"switchTab",think:"/practice/pages/think"},stepEditable:!1,isStuInGroup:!1},r.$repeat={},r.$props={"step-list":{"xmlns:v-bind":"","v-bind:list.sync":"datalist","v-bind:editable.sync":"stepEditable","v-bind:parentOffset.sync":"parentScrollTop"},"rich-button1":{text:"添加步骤",theme:"grey","xmlns:v-on":"",width:"90%"},"rich-button2":{text:"保存","v-bind:theme.sync":"saveBtnTheme",width:"90%"},"rich-button3":{text:"提交",theme:"green",width:"100%;"},dialog:{class:"add-step-dialog","v-bind:visible.sync":"addStepDialogVisible"}},r.$events={"rich-button1":{"v-on:tap":"addStep"},"rich-button2":{"v-on:tap":"saveChange"},"rich-button3":{"v-on:tap":"onSubmitAddStep"}},r.components={"step-list":_stepList2.default,"rich-button1":_richButton2.default,"rich-button2":_richButton2.default,"rich-button3":_richButton2.default,dialog:_dialog2.default},r.computed={saveBtnTheme:function(){return this.isChanged?"green":"grey"}},r.methods={addStep:function(){this.addStepTitle="添加步骤",this.toEditStep=null,this.addStepDialogVisible=!0,this.$apply()},onSubmitAddStep:function(){if(this.toEditStep)this.toEditStep.ArrangeName=this.stepName,this.toEditStep.modelList[0].ArrangeContent=this.stepDesc,this.$apply();else{var e=new _Step.Step({ArrangeName:this.stepName,CourseFID:this.currentGroupInfo.CourseFID,GroupFID:this.currentGroupInfo.GroupFID,Creater:this.$parent.globalData.userInfo.FlnkID,SortCode:this.datalist.length+1,ArrangeContent:this.stepDesc});this.datalist.push(e),this.$apply()}this.stepName="",this.stepDesc="",this.isChanged=!0,this.addStepDialogVisible=!1,this.$apply()},saveChange:function(){var e=this;this.datalist.forEach(function(e,t){e.SortCode=t+1}),(0,_api.saveGroupArrangeList)(this.datalist).then(function(t){(0,_api.getCourseArrangeList)(e.currentGroupInfo.CourseFID,e.currentGroupInfo.GroupFID).then(function(t){t.forEach(function(e){var t=e.modelList&&e.modelList[0];t&&1!==t.ArrangeType&&(e.modelList=e.modelList.slice(0,1))}),e.datalist=t,e.isChanged=!1,e.$apply(),_wepy2.default.showToast({title:"保存成功"})})})},onNameInput:function(e){this.stepName=e.detail.value},onDescInput:function(e){this.stepDesc=e.detail.value},onScroll:function(e){this.parentScrollTop=e.detail.scrollTop,this.$apply()}},r.events={"disable-scroll":function(){this.scrollable=!1,this.$apply()},"enable-scroll":function(){this.scrollable=!0,this.isChanged=!0,this.$apply()},"edit-step":function(e){this.addStepTitle="编辑步骤",this.toEditStep=e,this.stepName=e.ArrangeName,this.stepDesc=e.modelList[0]&&e.modelList[0].ArrangeContent||"",this.addStepDialogVisible=!0,this.$apply()},"delete-step":function(e){var t=this;_wepy2.default.showModal({title:"提示",content:"删除步骤之后将无法恢复，确定删除该步骤？",success:function(i){var r=this;i.confirm&&(0,_api.deleteArrange)(e.FlnkID).then(function(i){var n=t.datalist.findIndex(function(t){return t.FlnkID===e.FlnkID});t.datalist.splice(n,1),r.isChanged=!0,t.$apply(),t.$com["step-list"].$apply()})}})},"check-change":function(){this.isChanged=!0}},r.watch={isUserLeader:function(e){e&&!this.queryParam?this.stepEditable=!0:this.stepEditable=!1},queryParam:function(e){!e&&this.isUserLeader?this.stepEditable=!0:this.stepEditable=!1}},n=i,_possibleConstructorReturn(r,n)}return _inherits(t,e),_createClass(t,[{key:"init",value:function(){var e=this,t=void 0;t=this.queryParam?this.queryParam:_wepy2.default.getStorageSync("activeTaskInfo"),this.currentGroupInfo=t,(0,_api.getGroupDetail)(t.GroupFID).then(function(t){var i=t.GroupLeader;e.isUserLeader=i===e.$parent.globalData.userInfo.FlnkID,e.$apply()}),(0,_api.getCourseArrangeList)(t.CourseFID,t.GroupFID).then(function(t){t.forEach(function(e){var t=e.modelList&&e.modelList[0];t&&1!==t.ArrangeType&&(e.modelList=e.modelList.slice(0,1))}),e.datalist=t,e.$apply()}),(0,_api.isStuInCourseGroup)(this.$parent.globalData.userInfo.FlnkID,t.CourseFID,t.GroupFID).then(function(t){e.isStuInGroup=t,e.$apply()},function(){e.isStuInGroup=!1,e.$apply()})}},{key:"onLoad",value:function(e){e&&e.courseId&&(this.queryParam={CourseFID:e.courseId,GroupFID:e.groupId},this.navigateUrlMap={prevKnow:"/practice/pages/prevKnow?courseId="+e.courseId+"&groupId="+e.groupId,practice:"/practice/pages/reviewFinishTask?courseId="+e.courseId+"&groupId="+e.groupId,practiceOpenType:"redirect",think:"/practice/pages/think?courseId="+e.courseId+"&groupId="+e.groupId},this.$apply()),this.isTeacher=this.$parent.globalData.userInfo.RoleNum+""=="2",this.init()}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(Arrange,"practice/pages/arrange"));