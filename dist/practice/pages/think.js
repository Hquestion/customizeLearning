"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_panel=require("./../../components/panel.js"),_panel2=_interopRequireDefault(_panel),_richButton=require("./../../components/rich-button.js"),_richButton2=_interopRequireDefault(_richButton),_dialog=require("./../../components/dialog.js"),_dialog2=_interopRequireDefault(_dialog),_step=require("./../../components/step.js"),_step2=_interopRequireDefault(_step),_emptyContent=require("./../../components/empty-content.js"),_emptyContent2=_interopRequireDefault(_emptyContent),_api=require("./../../api/index.js"),Think=function(e){function t(){var e,n,i,r;_classCallCheck(this,t);for(var o=arguments.length,a=Array(o),u=0;u<o;u++)a[u]=arguments[u];return n=i=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),i.config={navigationBarTitleText:"有反思"},i.$repeat={submitedStepList:{com:"step",props:"stepData.sync"}},i.$props={step:{"xmlns:v-bind":{value:"",for:"submitedStepList",item:"item",index:"index",key:"key"},"v-bind:stepData.sync":{value:"item",type:"item",for:"submitedStepList",item:"item",index:"index",key:"key"},"v-bind:index.sync":{value:"item.SortCode",for:"submitedStepList",item:"item",index:"index",key:"key"},"v-bind:editable.once":{value:"false",for:"submitedStepList",item:"item",index:"index",key:"key"},"v-bind:detailVisible.once":{value:"false",for:"submitedStepList",item:"item",index:"index",key:"key"}},"rich-button":{theme:"green",text:"填写反思",size:"big",iconSrc:"../../images/yfs.png","xmlns:v-on":""},"rich-button2":{text:"提交",theme:"green",width:"100%;"},dialog:{class:"edit-think-dialog","v-bind:visible.sync":"editThinkDialogVisible"},"empty-content":{text:"TA还没有提交任何步骤"}},i.$events={"rich-button":{"v-on:tap":"onEditThink"},"rich-button2":{"v-on:tap":"onSubmitThink"}},i.components={panel:_panel2.default,"rich-button":_richButton2.default,"rich-button2":_richButton2.default,dialog:_dialog2.default,step:_step2.default,"empty-content":_emptyContent2.default},i.data={currentUser:{},editThinkDialogVisible:!1,myThinkContent:"",myThinkID:"",currentGroupInfo:null,inputThinkContent:"",submitedStepList:[],queryParam:null,navigateUrlMap:{prevKnow:"/practice/pages/prevKnow",practice:"/pages/practice",practiceOpenType:"switchTab",arrange:"/practice/pages/arrange"},groupMembers:[],currentMember:null},i.computed={canEditThink:function(){return!this.queryParam&&this.currentMember&&this.currentMember.MemberFID===this.currentUser.FlnkID}},i.methods={onEditThink:function(){this.inputThinkContent=this.myThinkContent,this.editThinkDialogVisible=!0},onSubmitThink:function(){var e=this;(0,_api.saveThinkContent)({FlnkID:this.myThinkID||"",StudentFID:this.$parent.globalData.userInfo.FlnkID,StudentName:this.$parent.globalData.userInfo.XM,ReflectContent:this.inputThinkContent,GroupFID:this.currentGroupInfo.GroupFID,CourseFID:this.currentGroupInfo.CourseFID}).then(function(t){e.myThinkContent=e.inputThinkContent,e.myThinkID=t,e.editThinkDialogVisible=!1,e.$apply()},function(){e.editThinkDialogVisible=!1,e.$apply()})},onThinkInput:function(e){this.inputThinkContent=e.detail.value},previewImg:function(e){_wepy2.default.previewImage({urls:[e]})},playVoice:function(e){var t=_wepy2.default.createInnerAudioContext();t.autoplay=!1,t.src=e,t.onEnded(function(){t.stop()}),t.onError(function(e){t.stop()}),t.play()},setCurrentMember:function(e){this.currentMember=e,this.$apply(),this.loadMemberData(e)}},r=n,_possibleConstructorReturn(i,r)}return _inherits(t,e),_createClass(t,[{key:"loadMemberData",value:function(e){var t=this;(0,_api.getThinkContent)(e.MemberFID,this.currentGroupInfo.GroupFID).then(function(e){"4000"===e.Code?(t.myThinkContent=e.ResultObj.ReflectContent,t.myThinkID=e.ResultObj.FlnkID):t.myThinkContent="",t.$apply()},function(){t.myThinkContent="",t.$apply()}),(0,_api.getUserSubmitSteps)(e.MemberFID,this.currentGroupInfo.GroupFID).then(function(e){t.submitedStepList=e,t.submitedStepList.forEach(function(e){e.modelList.forEach(function(e){e.WorkArrangeList.forEach(function(e){e.msgData=JSON.parse(e.MessageBody)})})}),t.$apply()},function(){t.submitedStepList=[],t.$apply()})}},{key:"init",value:function(){var e=this;this.queryParam?this.currentGroupInfo=this.queryParam:this.currentGroupInfo=_wepy2.default.getStorageSync("activeTaskInfo"),this.currentUser=this.$parent.globalData.userInfo,(0,_api.getGroupMembers)(this.currentGroupInfo.GroupFID).then(function(t){var n=t.filter(function(e){return 3===e.MemberIdentity}),i=n.findIndex(function(t){return t.MemberFID===e.$parent.globalData.userInfo.FlnkID});if(i>0){var r=n[i];n.splice(i,1),n.unshift(r)}e.groupMembers=n,e.currentMember=n[0],e.loadMemberData(e.currentMember),e.$apply()},function(t){e.groupMembers=[],e.$apply()})}},{key:"onLoad",value:function(e){e&&e.courseId&&(this.queryParam={CourseFID:e.courseId,GroupFID:e.groupId},this.navigateUrlMap={prevKnow:"/practice/pages/prevKnow?courseId="+e.courseId+"&groupId="+e.groupId,practice:"/practice/pages/reviewFinishTask?courseId="+e.courseId+"&groupId="+e.groupId,practiceOpenType:"redirect",arrange:"/practice/pages/arrange?courseId="+e.courseId+"&groupId="+e.groupId},this.$apply()),this.init()}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(Think,"practice/pages/think"));